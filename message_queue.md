# Message Queue

消息队列是一种进程间通信或同一进程的不同线程间的通信方式. 实际上，消息队列常常保存在链表结构中.拥有权限的进程可以向消息队列中写入或读取消息.

消息队列本身是异步的，它允许接收者在消息发送很长时间后再取回消息，这和大多数通信协议是不同的。例如WWW中使用的HTTP协议是同步的，因为客户端在发出请求后必须等待服务器回应。然而，很多情况下我们需要异步的通信协议。比如，一个进程通知另一个进程发生了一个事件，但不需要等待回应。但消息队列的异步特点，也造成了一个缺点，就是接收者必须轮询消息队列，才能收到最近的消息.

保证同一用户的消息按照顺序处理是应用的常见需求，发表微博、删除微博这两个操作必须按序处理，乱序势必造成业务逻辑错误。

[reference](http://www.bitstech.net/tag/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C-%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/)

如何保证消息处理顺序？以下是常见的几种做法。

设计一： 单线程处理。 虽然单线程处理非常简单好用，但是单线程限制了系统吞吐率。

设计二： 每个用户一个队列。看起来很美，实际上基本不可行。首先，每个消息队列基本都没啥消息， 其次， 不可能为每个用户安排一个线程。

设计三：  静态消息分发。系统设计分发线程和工作线程，每工作线程设置一个线程私有的消息队列，工作线程从私有消息队列取消息，执行业务逻辑。假定工作线程个数为N,  分发线程从全局的消息队列取消息，推消息到第 Hash(用户名）%N个线程私有队列。  静态消息分发一般来说够用，但也存在一些弱点。 首先存在伪冲突，隶属于同一个私有队列的消息按序处理，慢消息将阻塞私有队列中的后续消息，所以无法适用于实时性要求较高的应用。 其次，全局阻塞问题。线程私有队列慢时，分发线程停顿 ，造成全局停顿，几乎无法接受。

